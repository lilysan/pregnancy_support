<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Translate | Pregnancy Support</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" href="../reset.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="../style.css">
</head>
<body>
<div class="container">
    <div class="loader">
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <h1 class="title_link mt-3">Translate App List</h1>
    <div class="d-grid gap-2 mt-3 mb-3">
        <a href="https://translate.google.com/m/translate" class="btn btn-primary btn_google" type="button">Google Translate</a>
        <a href="https://www.deepl.com/" class="btn btn-primary btn_deepl" type="button">DeepL</a>
    </div>

    <div class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Modal body text goes here.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyUUS9qijnORQTAxUzVXLlsDigodcNn-uANaFjQpiRXqS5mQcIFlNRWYerSkzELOc5d/exec";
    const LIFF_ID = "2005594923-wN8OjyGd";
    const APP_URL = {
        deepl: {
            IPHONE_STORE_URL: 'https://apps.apple.com/app/id1552407475',
            IPHONE_URL_SCHEME: 'deepl://',
            ANDROID_STORE_URL: 'https://play.google.com/store/apps/details?id=com.deepl.mobiletranslator',
            ANDROID_URL_SCHEME: 'deepl://app',
            CHROME_URL_SCHEME: 'intent://app/#Intent;scheme=deepl;package=com.deepl.mobiletranslator;end'
        },
        google: {
            IPHONE_STORE_URL: 'https://apps.apple.com/id414706506',
            IPHONE_URL_SCHEME: 'googletranslate://',
            ANDROID_STORE_URL: 'https://play.google.com/store/apps/details?id=com.google.android.apps.translate',
            ANDROID_URL_SCHEME: 'googletranslate://*/support_for_lang',
            CHROME_URL_SCHEME: 'intent://*/support_for_lang#Intent;scheme=googletranslate;package=com.google.android.apps.translate;end',
            ANDROID_APP_LINK: 'https://translate.google.com/m/translate'
        }
    }
    // getTranslator("");
    // $(".btn_google").on("click", function(e){
    //     const ret = lunchApp("google");
    //     if(!ret){
    //         e.preventDefault();
    //     }
    // });
    // $(".btn_deepl").on("click", function(e){
    //     const ret = lunchApp("deepl");
    //     if(!ret){
    //         e.preventDefault();
    //     }
    // });

    liff.init({
        liffId: LIFF_ID, // Use own liffId
        withLoginOnExternalBrowser: true, // Enable automatic login process
    }).then(() => {
        // Start to use liff's api
        const idToken = liff.getIDToken();
        getTranslator(idToken);

        $(".btn_google").on("click", function(e){
            const ret = lunchApp("google");
            if(!ret){
                e.preventDefault();
            }
        });
        $(".btn_deepl").on("click", function(e){
            const ret = lunchApp("deepl");
            if(!ret){
                e.preventDefault();
            }
        });
      }).catch((err) => {
        // Error happens during initialization
        liff.logout();
        alert("LIFF init failed.");
    });

    function getTranslator(idToken){
        //TODO: ...
        $(".loader").hide();
    }

    function lunchApp(app) {
        function execute(appUrl, storeUrl) {
            const iframe = document.createElement('iframe');
            iframe.style.visibility = "hidden";
            iframe.src = appUrl;
            document.body.appendChild(iframe);
            const time = (new Date()).getTime();
            setTimeout(function(){
                const now = (new Date()).getTime();
                document.body.removeChild(iframe);
                if((now-time)>400) {
                    // 元の画面に戻ってきた時にポップアップを抑制するため
                    return;
                }
                document.location = storeUrl;
            }, 300);
        }

        const agent = navigator.userAgent;
        if (agent.search(/iPhone|iPod|iPad/) !== -1) {
            // iPhone
            execute(APP_URL[app].IPHONE_URL_SCHEME, APP_URL[app].IPHONE_STORE_URL, true);
            return false;
        } else if (agent.search(/Android/) !== -1 && agent.search(/Chrome/) !== -1) {
            // Chrome in Android
            // https://developer.chrome.com/multidevice/android/intentsを参考。
            $(`.btn_${app}`).attr('href', APP_URL[app].CHROME_URL_SCHEME);
            return true;
        } else if (agent.search(/Android/) !== -1) {
            // Android
            execute(APP_URL[app].ANDROID_URL_SCHEME, APP_URL[app].ANDROID_STORE_URL, false);
            return false;
        }

        return true;
    }

    $(document).ready(function(event) {
        $('#view-url').on('click', function(event) {
            var ret = lunchApp(event);
            if (!ret) { event.preventDefault(); }
        });
    });
</script>

</body>
</html>
